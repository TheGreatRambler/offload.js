/*
 PSON (c) 2013 Daniel Wirtz <dcode@dcode.io>
 Released under the Apache License, Version 2.0
 see: https://github.com/dcodeIO/PSON for details
*/
(function(k){function n(k){if(!k)throw Error("PSON requires ByteBuffer.js: Get it at https://github.com/dcodeIO/ByteBuffer.js");var e={T:{ZERO:0,MAX:239,NULL:240,TRUE:241,FALSE:242,EOBJECT:243,EARRAY:244,ESTRING:245,OBJECT:246,ARRAY:247,INTEGER:248,LONG:249,FLOAT:250,DOUBLE:251,STRING:252,STRING_ADD:253,STRING_GET:254,BINARY:255}};e.Encoder=function(f,c){var e=new f(4);e.length=4;var g=f.Long,b=function(a,d,c){this.dict={};this.next=0;if(a&&Array.isArray(a))for(;this.next<a.length;)this.dict[a[this.next]]=
this.next++;this.progressive=!!d;this.options=c||{}};b.prototype.encode=function(a,d){var c=!1;d||(d=new f,c=!0);var b=d.littleEndian;try{return this._encodeValue(a,d.LE()),d.littleEndian=b,c?d.flip():d}catch(e){throw d.littleEndian=b,e;}};b.prototype._encodeValue=function(a,d,b){if(null===a)d.writeUint8(c.NULL);else switch(typeof a){case "function":a=a.toString();case "string":0===a.length?d.writeUint8(c.ESTRING):this.dict.hasOwnProperty(a)?(d.writeUint8(c.STRING_GET),d.writeVarint32(this.dict[a])):
(d.writeUint8(c.STRING),d.writeVString(a));break;case "number":b=parseInt(a);a===b?(b=f.zigZagEncode32(a),b<=c.MAX?d.writeUint8(b):(d.writeUint8(c.INTEGER),d.writeVarint32ZigZag(a))):(e.writeFloat32(a,0),a===e.readFloat32(0)?(d.writeUint8(c.FLOAT),d.writeFloat32(a)):(d.writeUint8(c.DOUBLE),d.writeFloat64(a)));break;case "boolean":d.writeUint8(a?c.TRUE:c.FALSE);break;case "object":var h;if(Array.isArray(a))if(0===a.length)d.writeUint8(c.EARRAY);else for(d.writeUint8(c.ARRAY),d.writeVarint32(a.length),
h=0;h<a.length;h++)this._encodeValue(a[h],d);else if(g&&a instanceof g)d.writeUint8(c.LONG),d.writeVarint64ZigZag(a);else try{a=f.wrap(a),d.writeUint8(c.BINARY),d.writeVarint32(a.remaining()),d.append(a)}catch(k){var m=Object.keys(a),l=0;for(h=0;h<m.length;h++)"undefined"!==typeof a[m[h]]&&l++;if(0===l)d.writeUint8(c.EOBJECT);else for(d.writeUint8(c.OBJECT),d.writeVarint32(l),b||(b=!!a._PSON_EXCL_),h=0;h<m.length;h++)l=m[h],"undefined"!==typeof a[l]&&(this.dict.hasOwnProperty(l)?(d.writeUint8(c.STRING_GET),
d.writeVarint32(this.dict[l])):(this.progressive&&!b?(this.dict[l]=this.next++,d.writeUint8(c.STRING_ADD)):d.writeUint8(c.STRING),d.writeVString(l)),this._encodeValue(a[l],d))}break;case "undefined":d.writeUint8(c.NULL)}};return b}(k,e.T);e.Decoder=function(f,c){var e=f.Long,g=function(b,a,d){this.dict=b&&Array.isArray(b)?b:[];this.progressive=!!a;this.options=d||{}};g.prototype.decode=function(b){b instanceof f||(b=f.wrap(b));var a=b.littleEndian;try{var d=this._decodeValue(b.LE());b.littleEndian=
a;return d}catch(c){throw b.littleEndian=a,c;}};g.prototype._decodeValue=function(b){var a=b.readUint8();if(a<=c.MAX)return f.zigZagDecode32(a);switch(a){case c.NULL:return null;case c.TRUE:return!0;case c.FALSE:return!1;case c.EOBJECT:return{};case c.EARRAY:return[];case c.ESTRING:return"";case c.OBJECT:for(var a=b.readVarint32(),d={};0<=--a;)d[this._decodeValue(b)]=this._decodeValue(b);return d;case c.ARRAY:a=b.readVarint32();for(d=[];0<=--a;)d.push(this._decodeValue(b));return d;case c.INTEGER:return b.readVarint32ZigZag();
case c.LONG:return e?b.readVarint64ZigZag():b.readVarint32ZigZag();case c.FLOAT:return b.readFloat32();case c.DOUBLE:return b.readFloat64();case c.STRING:return b.readVString();case c.STRING_ADD:return b=b.readVString(),this.dict.push(b),b;case c.STRING_GET:return this.dict[b.readVarint32()];case c.BINARY:return a=b.readVarint32(),d=b.slice(b.offset,b.offset+a),b.offset+=a,d;default:throw Error("Illegal type at "+b.offset+": "+a);}};return g}(k,e.T);e.Pair=function(){var f=function(){};f.prototype.encode=
function(c){return this.encoder.encode(c)};f.prototype.toArrayBuffer=function(c){return this.encoder.encode(c).toArrayBuffer()};f.prototype.toBuffer=function(c){return this.encoder.encode(c).toBuffer()};f.prototype.decode=function(c){return this.decoder.decode(c)};return f}();e.StaticPair=function(f,c,e){var g=function(b,a){f.call(this);this.encoder=new c(b,!1,a);this.decoder=new e(b,!1,a)};g.prototype=Object.create(f.prototype);return g}(e.Pair,e.Encoder,e.Decoder);e.ProgressivePair=function(f,c,
k){var g=function(b,a){f.call(this);this.encoder=new c(b,!0,a);this.decoder=new k(b,!0,a)};g.prototype=Object.create(f.prototype);g.prototype.exclude=function(b){e.exclude(b)};g.prototype.include=function(b){e.include(b)};return g}(e.Pair,e.Encoder,e.Decoder);e.exclude=function(e){"object"===typeof e&&Object.defineProperty(e,"_PSON_EXCL_",{value:!0,enumerable:!1,configurable:!0})};e.include=function(e){"object"===typeof e&&delete e._PSON_EXCL_};return e}"undefined"!=typeof module&&module.exports?
module.exports=n(require("bytebuffer")):"undefined"!=typeof define&&define.amd?define("PSON",["ByteBuffer"],n):(k.dcodeIO||(k.dcodeIO={}),k.dcodeIO.PSON=n(k.dcodeIO.ByteBuffer))})(this);
